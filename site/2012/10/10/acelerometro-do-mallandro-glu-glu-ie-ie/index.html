<!doctype html>
<html lang="pt-BR">

<head>
	<meta charset="UTF-8" />
	
		<title>Acelerômetro do Mallandro, Glu glu ié ié! | Open Blog</title>
	
	
		<meta name="author" content="Almir Filho" />
	
	
		<meta name="keywords" content="javascript, html5, api, acelerometro, aceleracao, orientacao, jogo, chrome, firefox, orientation, acceleration, gravity, gravidade, serginho, mallandro, malandro, box2d, webaudio, rotacao
" />
	
	
		<meta name="description" content="Hoje vamos entender como funciona a nova API de Acelerômetro do HTML5, que usei num experimento bem legal chamado Cilada do Mallandro." />
	
	<meta name="language" content="pt" />
	<meta name="content-language" content="pt-BR" />
	<meta name="robots" content="all" />
	<meta name="distribution" content="Global" />
	<meta name="resource-type" content="document" />

	<link rel="icon" type="image/png" href="/assets/img/favicon.png" />
    <link href="/assets/css/screen.css?2013-02-22" media="screen, projection" rel="stylesheet" type="text/css" />
    <!--[if IE]>
    	<link href="/assets/css/ie.css?2013-02-22" media="screen, projection" rel="stylesheet" type="text/css" />
  	<![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Ubuntu:300' rel='stylesheet' type='text/css'>
</head>

<body>

	<div id="wrapper">
		
		<header id="main">
	<h1><a href="/" id="logo">.openBlog()</a></h1>
</header>
		
		<section id="content">

			<section class="post-container" itemscope itemtype="http://schema.org/BlogPosting">
				<span class="hidden" itemprop="publisher">Open Blog</span>
				<article>
					<header>
						<h1><a href="/2012/10/10/acelerometro-do-mallandro-glu-glu-ie-ie/" itemprop="headline"><span>Acelerômetro</span> do Mallandro, <br />Glu glu <span class="light">ié ié</span>!</a></h1>
					</header>
					<section itemprop="articleBody">
						
						<style>
	iframe {
		width: 700px;
		height: 432px;
		border: none;
	}
</style>
<p>Quem nunca brincou daquele joguinho com uma bolinha num labirinto? O objetivo era basicamente desviar dos buracos e chegar até o final. Infelizmente eu não consegui descobrir seu nome, mas basicamente você inclinava o tabuleiro e a bolinha se movia, e era assim que se jogava o jogo. Simples.</p>

<p>Nos últimos dias eu me envolvi e me diverti bastante com o desenvolvimento desse mesmo jogo – só que, claro, numa versão <em>web</em> que funcionasse diretamente no navegador.</p>

<p>Hoje vamos entender como funciona a nova <strong>API de Acelerômetro do HTML5</strong>. Mas antes de começarmos a nerdice, peço que tentem jogar um pouco a <strong>Cilada do Mallandro</strong>! (tem som)</p>
<iframe class='img' frameborder='0' src='http://almirfilho.github.com/cilada/'>frame do jogo</iframe>
<h3 id='requisitos_para_jogar'>Requisitos para jogar</h3>

<ul>
<li>O computador deve possuir <strong>hardware de acelerômetro</strong> (qualquer MacBook tem).</li>

<li>Os únicos navegadores que dão suporte são o <em>Google Chrome</em> e <em>Mozilla Firefox</em>.</li>
</ul>

<h3 id='observaes'>Observações</h3>

<ul>
<li>Pode ser melhor jogar diretamente da <a href='http://almirfilho.github.com/cilada/'>página do projeto</a>, pois aqui pelo post pode ficar meio lento (pra você que não tem uma Ferrari como processador, assim como eu).</li>

<li>Quem conseguir vencer, ganha um <em>brinde</em>.</li>
</ul>

<h2 id='cilada_do_mallandro'>Cilada do Mallandro!</h2>

<p>Pra quem quiser dar uma olhada no código, o projeto é aberto e está disponível no <a href='http://github.com/almirfilho/cilada'>Github</a>.</p>

<p>Utilizei a <em>engine</em> física <strong><a href='http://code.google.com/p/box2dweb/'>Box2D</a></strong> (portada para JavaScript) para tratar as colisões e impactos de maneira eficiente, a <strong>API Canvas</strong> para desenhar a interface gráfica, <strong>jQuery</strong> (bem, é jQuery), as novíssimas <strong>APIs para Acelerômetro e Web Audio</strong>, e finalmente escrevi tudo em <strong><a href='http://coffeescript.com.br'>CoffeeScript</a></strong>.</p>

<p>Pretendo fazer um outro post detalhado sobre o desenvolvimento do Cilada do Mallandro – sobre como utilizar a <em>engine</em> Box2D, a API Web Audio e tudo mais –, mas por hora, falarei apenas da <strong>API para Acelerômetro</strong> – que é o foco deste post.</p>

<h2 id='uma_api_muito_louca'>Uma API muito louca</h2>

<p>HTML5 define uma nova API para ter acesso às informações fornecidas por dispositivos de aceleração e orientação (nos dispositivos que possuem acelerômetro). Esta API consiste basicamente da implementação de três eventos: <code>deviceorientation</code>, <code>devicemotion</code> e <code>compassneedscalibration</code>. Para saber se seu navegador já suporta esses eventos, apenas realize os testes (também pode ser necessário testar com <em>vendor prefixes</em>):</p>
<div class='highlight'><pre><code class='javascript'><span class='k'>if</span><span class='p'>(</span> <span class='nb'>window</span><span class='p'>.</span><span class='nx'>DeviceOrientationEvent</span> <span class='o'>!=</span> <span class='kc'>null</span> <span class='p'>){</span>
    <span class='c1'>// seu navegador suporta DeviceOrientationEvent</span>
<span class='p'>}</span>

<span class='k'>if</span><span class='p'>(</span> <span class='nb'>window</span><span class='p'>.</span><span class='nx'>DeviceMotionEvent</span> <span class='o'>!=</span> <span class='kc'>null</span> <span class='p'>){</span>
    <span class='c1'>// seu navegador suporta DeviceMotionEvent</span>
<span class='p'>}</span>

<span class='k'>if</span><span class='p'>(</span> <span class='nb'>window</span><span class='p'>.</span><span class='nx'>CompassNeedsCalibrationEvent</span> <span class='o'>!=</span> <span class='kc'>null</span> <span class='p'>){</span>
    <span class='c1'>// seu navegador suporta CompassNeedsCalibrationEvent</span>
<span class='p'>}</span>
</code></pre></div>
<p>Antes de prosseguirmos com os eventos, algo deve ficar bem claro: os eixos do sistema de coordenadas usados. Os eventos retornam dados referentes a cada um dos eixos <strong>X</strong>, <strong>Y</strong> e <strong>Z</strong> abaixo:</p>
<figure>
	<img alt='Eixos' height='264' src='/images/posts/2012-10-10-eixos.png' title='Eixos' />
</figure>
<p>Onde:</p>

<ul>
<li><strong>X</strong> é o eixo que &#8220;percorre&#8221; a tela do dispositivo de lado a lado (perpendicular a Y e Z).</li>

<li><strong>Y</strong> é o eixo que &#8220;percorre&#8221; a tela do dispositivo de baixo a cima (perpendicular a X e Z).</li>

<li><strong>Z</strong> é o eixo que completa o sistema, é representado como estivesse &#8220;saindo&#8221; da tela (perpendicular a X e Y).</li>
</ul>

<p>É claro que, estando em um <em>laptop</em>, estes eixos serão relativos ao plano no teclado, e não ao plano da tela.</p>

<h3 id='o_evento_deviceorientation'>O evento deviceorientation</h3>

<p>Disparado quando há novos dados disponíveis fornecidos pelo sensor de orientação, ou seja, quando a orientação atual muda. Para termos acesso a estes dados, precisamos apenas definir uma função manipuladora para o evento <code>deviceorientation</code>:</p>
<div class='highlight'><pre><code class='javascript'><span class='nb'>window</span><span class='p'>.</span><span class='nx'>addEventListener</span><span class='p'>(</span> <span class='s1'>&#39;deviceorientation&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span> <span class='nx'>orientData</span> <span class='p'>){</span>
    <span class='c1'>// faça algo de legal aqui</span>
<span class='p'>})</span>
</code></pre></div>
<p>Todos os dados disponíveis na ocorrência do evento estarão em <code>orientData</code>. As propriedades contidas em <code>orientData</code> são: <code>target</code>, <code>type</code>, <code>canBubble</code>, <code>cancelable</code>, <code>alpha</code>, <code>beta</code>, <code>gamma</code> e <code>absolute</code>.</p>

<p>Neste post apenas nos interessam as propriedades <code>alpha</code>, <code>beta</code> e <code>gamma</code>. Mas para uma descrição detalhada sobre cada uma delas, clique <a href='https://developer.mozilla.org/en-US/docs/Mozilla_event_reference/deviceorientation'>aqui</a>.</p>

<p><code>alpha</code>, <code>beta</code> e <code>gamma</code> representam a rotação em graus <strong>em torno</strong> de cada um dos eixos Z, X e Y respectivamente, como ilustrado abaixo:</p>
<figure>
	<img alt='Rotações' height='299' src='/images/posts/2012-10-10-rotacao.png' title='Rotações' />
</figure>
<p>Por exemplo, se deixarmos o <em>smartphone</em> do desenho acima em pé, ou seja, com o eixo Y apontando para cima e o eixo Z apontando para nós, <code>beta</code> valerá 90, pois apenas realizamos uma rotação de <strong>90° em torno do eixo X</strong>. Já se deixarmos o mesmo <em>smartphone</em> de cabeça para baixo, <code>beta</code> valerá -90, pois realizamos a mesma rotação no sentido contrário.</p>

<h3 id='o_evento_devicemotion'>O evento devicemotion</h3>

<p>O evento <code>devicemotion</code> é disparado periodicamente e fornece dados sobre movimentos físicos realizados durante um certo intervalo de tempo (o intervalo entre as chamadas do próprio evento). Fornece dados sobre taxa de rotação, assim como a aceleração referente a cada um dos três eixos. Para termos acesso a estes dados, apenas definimos uma função para manipulação do evento <code>devicemotion</code>:</p>
<div class='highlight'><pre><code class='javascript'><span class='nb'>window</span><span class='p'>.</span><span class='nx'>addEventListener</span><span class='p'>(</span> <span class='s1'>&#39;devicemotion&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span> <span class='nx'>eventData</span> <span class='p'>){</span>
    <span class='c1'>// faça algo de legal aqui</span>
<span class='p'>})</span>
</code></pre></div>
<p>Os dados fornecidos por <code>eventData</code> são: <code>target</code>, <code>type</code>, <code>canBubble</code>, <code>cancelable</code>, <code>acceleration</code>, <code>accelerationIncludingGravity</code>, <code>interval</code> e <code>rotationRate</code>. Novamente, apenas irei focar em algumas propriedades, para uma descrição completa de cada uma, clique <a href='https://developer.mozilla.org/en-US/docs/Mozilla_event_reference/devicemotion'>aqui</a>.</p>

<ul>
<li><code>acceleration</code> Fornece a aceleração do dispositivo em cada um dos três eixos – propriedades <code>x</code>, <code>y</code> e <code>z</code> (unidade em m/s²).</li>

<li><code>accelerationIncludingGravity</code> Igualmente a <code>acceleration</code>, fornece a aceleração do dispositivo em cada um dos três eixos (X, Y e Z). A diferença está no fato de o <em>hardware</em> ter ou não a capacidade de <strong>excluir</strong> o efeito da gravidade. No caso de o dispositivo estar &#8220;deitado&#8221; e em repouso, a aceleração no eixo Z sempre terá um valor aproximado de 9.8 (gravidade terrestre) somado a seu valor.</li>

<li><code>rotationRate</code> Provê as taxas de rotação referentes a cada eixo, propriedades <code>alpha</code>, <code>beta</code> e <code>gamma</code> (exatamente os mesmos dados fornecidos pelo evento <code>deviceorientation</code>).</li>
</ul>

<h3 id='o_evento_compassneedscalibration'>O evento compassneedscalibration</h3>

<p>Como o próprio nome diz, este evento deverá ser acionado quando o navegador determinar que um acelerômetro precisa ser calibrado. Isso deve ocorrer apenas se for preciso aumentar a precisão ou corrigir alguma irregularidade nos dados. Este evento possui uma ação padrão que fica a cargo de cada navegador. O navegador pode, por exemplo, mostrar detalhes ao usuário de como realizar a calibração. Também deve ser possível modificar este comportamento padrão de modo que as aplicações possam apresentar sua própria interface para esta tarefa. Para mais detalhes clique <a href='http://dev.w3.org/geo/api/spec-source-orientation.html#compassneedscalibration'>aqui</a>.</p>

<h2 id='divergncias_entre_navegadores'>Divergências entre navegadores</h2>

<p>Como já foi dito, apenas dois navegadores implementam eventos de acelerômetro atualmente: <strong>Google Chrome</strong> e <strong>Mozilla Firefox</strong>.</p>

<p>Inicialmente eu desenvolvi o <strong>Cilada do Mallandro</strong> testando no Chrome, e depois quando fui testar no Firefox, algumas coisas não funcionaram. Vimos que existem dois principais eventos para obtermos dados de orientação, <code>deviceorientation</code> e <code>devicemotion</code>, mas cada navegador implementa apenas um dos dois atualmente.</p>

<h3 id='no_chrome'>No Chrome</h3>

<p>Como este é um jogo que necessita de dados sobre orientação, e não sobre aceleração, comecei o desenvolvimento utilizando o evento <code>deviceorientation</code>, o que ocorreu sem problemas no Google Chrome, pois o mesmo apenas dá suporte a este evento – e não ao <code>devicemotion</code>.</p>

<h3 id='no_firefox'>No Firefox</h3>

<p>Já no Firefox, a coisa muda <strong>completamente</strong>. Diferente do Chrome, ele dá suporte ao evento <code>devicemotion</code> e não ao <code>deviceorientation</code>. &#8220;OK&#8221;, pensei eu, &#8220;então apenas usarei os dados da propriedade <code>rotationRate</code>&#8221;, concluí. Mas, cadê o <code>rotationRate</code>? <code>rotationRate</code> sempre retornava igual a <code>null</code>, então a saída foi usar os únicos dados que o evento <code>devicemotion</code> estava me fornecendo: <code>accelerationIncludingGravity</code>, que fornece a aceleração em cada um dos eixos com as propriedades <code>x</code>, <code>y</code> e <code>z</code>.</p>

<p>Particularmente, acho que o Firefox implementa da maneira incorreta. Pois se inclinarmos nosso dispositivo, ele informará uma aceleração em cada um dos eixos de maneira constante, inclusive se mantermos o dispositivo em repouso com uma certa inclinação. <strong>Então, por que minha aceleração no eixo X continua constante se meu dispositivo está em repouso?</strong> Simplesmente não faz sentido. Na minha opinião estes dados deveriam ser convertidos em graus e disponibilizados através da propriedade <code>rotationRate</code> ou no evento <code>deviceorientation</code>.</p>

<p>No final das contas, tive que obter a &#8220;aceleração&#8221; nos eixos e converter os valores de modo que se aproximassem dos valores em graus (como se estivesse obtendo a orientação com <code>deviceorientation</code>). Ou seja, <strong>uma bela de uma gâmbi</strong>, algo parecido com isto:</p>
<div class='highlight'><pre><code class='javascript'><span class='c1'>// no Chrome, obtendo a orientação</span>
<span class='nb'>window</span><span class='p'>.</span><span class='nx'>addEventListener</span><span class='p'>(</span> <span class='s1'>&#39;devicemotion&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span> <span class='nx'>orientData</span> <span class='p'>){</span>
    <span class='c1'>// seta o próximo impulso na bola</span>
    <span class='nx'>ball</span><span class='p'>.</span><span class='nx'>impulse</span><span class='p'>.</span><span class='nx'>x</span> <span class='o'>=</span> <span class='nx'>orientData</span><span class='p'>.</span><span class='nx'>gamma</span> <span class='o'>/</span> <span class='mi'>2</span> <span class='o'>/</span> <span class='nx'>scale</span>
    <span class='nx'>ball</span><span class='p'>.</span><span class='nx'>impulse</span><span class='p'>.</span><span class='nx'>y</span> <span class='o'>=</span> <span class='nx'>orientData</span><span class='p'>.</span><span class='nx'>beta</span> <span class='o'>/</span> <span class='mi'>2</span> <span class='o'>/</span> <span class='nx'>scale</span>
<span class='p'>})</span>

<span class='c1'>// no Firefox, obtendo a aceleração</span>
<span class='nb'>window</span><span class='p'>.</span><span class='nx'>addEventListener</span><span class='p'>(</span> <span class='s1'>&#39;devicemotion&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span> <span class='nx'>eventData</span> <span class='p'>){</span>
    <span class='c1'>// seta o próximo impulso na bola</span>
    <span class='nx'>ball</span><span class='p'>.</span><span class='nx'>impulse</span><span class='p'>.</span><span class='nx'>x</span> <span class='o'>=</span> <span class='nx'>eventData</span><span class='p'>.</span><span class='nx'>accelerationIncludingGravity</span><span class='p'>.</span><span class='nx'>x</span> <span class='o'>*</span> <span class='p'>(</span><span class='o'>-</span><span class='mi'>3</span><span class='p'>)</span> <span class='o'>/</span> <span class='nx'>scale</span>
    <span class='nx'>ball</span><span class='p'>.</span><span class='nx'>impulse</span><span class='p'>.</span><span class='nx'>y</span> <span class='o'>=</span> <span class='nx'>eventData</span><span class='p'>.</span><span class='nx'>accelerationIncludingGravity</span><span class='p'>.</span><span class='nx'>y</span> <span class='o'>*</span> <span class='mi'>3</span> <span class='o'>/</span> <span class='nx'>scale</span>
<span class='p'>})</span>
</code></pre></div>
<p>A variável <code>scale</code> é apenas uma constante do jogo.</p>

<h2 id='suporte_de_hardware'>Suporte de hardware</h2>

<p>Praticamente todos os dispositivos móveis (<em>smartphones</em> e <em>tablets</em>) do mercado hoje em dia veem equipados com estes dispositivos, e o que não faltam também são aplicativos e jogos que se utilizam dessas habilidades. Já no <em>desktop</em> a coisa muda um pouco, com exceção dos MacBooks, não conheço outros computadores que possuam <em>hardware</em> de acelerômetro, e apesar de ter ouvido falar que outras fabricantes já estão embutindo acelerômetros em seus produtos, não posso afirmar tal fato.</p>
<table class='support'>
	<thead>
		<tr>
			<th class='subject'><h2>Suporte</h2></th>
			<th class='browser chrome'><div class='i' /></th>
			<th class='browser safari'><div class='i' /></th>
			<th class='browser firefox'><div class='i' /></th>
			<th class='browser ie'><div class='i' /></th>
			<th class='browser opera'><div class='i' /></th>
		</tr>
		<tr>
			<th />
			<th class='base' colspan='5' />
		</tr>
	</thead>
	<tbody>
		<tr>
			<td class='property'><code>DeviceOrientationEvent</code></td>
			<td>7</td>
			<td>--</td>
			<td>--</td>
			<td>--</td>
			<td>--</td>
		</tr>
		<tr>
			<td class='property'><code>DeviceMotionEvent</code></td>
			<td>--</td>
			<td>--</td>
			<td>6</td>
			<td>--</td>
			<td>--</td>
		</tr>
		<tr>
			<td class='property'><code class='smaller'>CompassNeedsCalibrationEvent</code></td>
			<td>--</td>
			<td>--</td>
			<td>--</td>
			<td>--</td>
			<td>--</td>
		</tr>
	</tbody>
	<tfoot>
		<tr>
			<td colspan='6'>O Firefox já dava suporte parcial ao <code class='small'>DeviceMotionEvent</code> com a interface <code class='small'>mozOrientation</code> a partir da versão 3.6.</td>
		</tr>
	</tfoot>
</table>
<h2 id='suporte_mvel'>Suporte Móvel</h2>

<p>Onde essas funcionalidades se fazem mais presentes, é justamente nos navegadores de dispositivos móveis. O <a href='http://caniuse.com'>caniuse.com</a> informa que:</p>

<ul>
<li><strong>Safari iOS</strong>: Desde a versão 4.2</li>

<li><strong>Opera Mobile</strong>: Desde a versão 12 (versão atual)</li>

<li><strong>Browser (Android)</strong>: Desde a versão 3.0</li>

<li><strong>Chrome (Android)</strong>: Desde a versão 18 (versão atual)</li>

<li><strong>Firefox (Android)</strong>: Desde a versão 15 (versão atual)</li>
</ul>
<aside class='fonte'>
    <h3>Referência</h3>
    <ul>
        <li>→<a alt='Detecting Device Orientation' href='https://developer.mozilla.org/en-US/docs/Detecting_device_orientation' title='Detecting Device Orientation'>Detecting Device Orientation</a> <span class='comment'>// MDN</span></li>
        <li>→<a alt='Orientation and Motion Data Explained' href='https://developer.mozilla.org/en-US/docs/DOM/Orientation_and_motion_data_explained' title='Orientation and Motion Data Explained'>Orientation and Motion Data Explained</a> <span class='comment'>// MDN</span></li>
        <li>→<a alt='DeviceOrientationEvent' href='https://developer.mozilla.org/en-US/docs/Mozilla_event_reference/deviceorientation' title='DeviceOrientationEvent'>DeviceOrientationEvent</a> <span class='comment'>// MDN</span></li>
        <li>→<a alt='DeviceMotionEvent' href='https://developer.mozilla.org/en-US/docs/Mozilla_event_reference/devicemotion' title='DeviceMotionEvent'>DeviceMotionEvent</a> <span class='comment'>// MDN</span></li>
        <li>→<a alt='DeviceOrientation Event Specification' href='http://dev.w3.org/geo/api/spec-source-orientation.html' title='DeviceOrientation Event Specification'>DeviceOrientation Event Specification</a> <span class='comment'>// W3C</span></li>
    </ul>
</aside>
					</section>
				</article>
			</section>

		</section><!-- end #content -->

	</div><!-- end #wrapper -->

</body>
</html>
